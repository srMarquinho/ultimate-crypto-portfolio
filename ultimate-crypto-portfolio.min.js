/* ultimate-crypto-portfolio - Version: 1.0.0 - https://github.com/srMarquinho/ultimate-crypto-portfolio - Marco Araujo */

function calcBoughtSold(){const[e,t,r,n,o,...i]=arguments;let s=filterData(e,null,null,...i);s=orderRangeByCol(s,t);let c={Bought:new Big(0),Sold:new Big(0)};const u={Bought:new Big(0),Sold:new Big(0)};return s.forEach((e,t)=>{const i=e[r-1],s=e[o-1],a=e[n-1];if(i&&s&&c[i]){if(n){if(u[i]=u[i].plus(a),!+u.Bought.minus(u.Sold))return void(c={Bought:new Big(0),Sold:new Big(0)})}c[i]=c[i].plus(s)}}),+c.Bought.minus(c.Sold)}function filterData(){let[e,t,r,...n]=arguments;const o=e.splice(0,1);return(t||r)&&(e=filterRowByDate(e,t,r)),n&&n.length&&n.filter(e=>e).forEach(t=>{e=filterRowByItem(e,t)}),o.concat(e)}function filterRowByItem(e,t){return e.reduce((e,r)=>(r.includes(t)&&e.push(r),e),[])}function filterRowByDate(e,t,r){return e.reduce((e,n)=>{if(!n[0])return e;const o=t&&n[0]>=t,i=r&&n[0]<=r;return o&&i?(e.push(n),e):(o&&!r&&e.push(n),i&&!t&&e.push(n),e)},[])}function sanitize(e){return e.replace("&amp;","&")}function tryValue(e,t){return e&&!isError(e)?e:t}function isError(e){return["#NULL!","#DIV/0!","#VALUE!","#REF!","#NAME?","#NUM!","#N/A","#ERROR!"].includes(e)}function orderRangeByCol(e,t){return e.filter(e=>e[t-1]).sort((e,r)=>e[t-1]===r[t-1]?0:e[0]<r[0]?-1:1)}function onOpen(){addUiItems(),createAllTriggers()}function addUiItems(){SpreadsheetApp.getUi().createMenu("PORTFOLIO").addItem("About","showWelcome").addItem("Refresh data","refreshResourceReq").addItem("Refresh portfolio calculations","refreshResourceCalc").addToUi()}function showWelcome(){const e=UrlFetchApp.fetch("https://raw.githubusercontent.com/srMarquinho/ultimate-crypto-portfolio/master/sidebar/welcome.html",{muteHttpExceptions:!0}).getContentText(),t=HtmlService.createHtmlOutput(e).setTitle("Ultimate Crypto Portfolio").setWidth(300);SpreadsheetApp.getUi().showSidebar(t)}function refreshResourceReq(){const e=SpreadsheetApp.getActiveSpreadsheet().getSheetByName("_resourceReq").getRange("A2"),t=e.getFormula();e.setFormula(null),SpreadsheetApp.flush(),e.setFormula(t)}function refreshResourceCalc(){const e=SpreadsheetApp.getActiveSpreadsheet().getSheetByName("_resourceCalc").getRange("A2"),t=e.getFormula();e.setFormula(null),SpreadsheetApp.flush(),e.setFormula(t)}function getResource(e,t){const r=getStores(e,t).QuoteSummaryStore;return r?[[getName(r),getStartDate(r),getMarketPrice(r),getMarketDayHigh(r),getMarketDayLow(r),get52WeekHigh(r),get52WeekLow(r),getMarketVolume(r),getAverageVolume10days(r),getVolume24h(r),getMarketCap(r),getMarketChangePercent(r)]]:[["Not Found"]]}function getStores(e,t){try{const r="https://finance.yahoo.com/quote/"+e+"-"+t+"?millisToAvoidCache="+(new Date).getTime(),n=UrlFetchApp.fetch(r,{muteHttpExceptions:!0}).getContentText(),o=new RegExp(/root.App.main = \{.*\:\{.*\:.*\}\}/g).exec(n)[0].substring(16);return JSON.parse(o).context.dispatcher.stores}catch(e){return Logger.log(e)}}function getName(e){return sanitize(e.summaryProfile.name)}function getStartDate(e){return e.summaryProfile.startDate}function getMarketPrice(e){return e.price.regularMarketPrice.raw}function getMarketDayHigh(e){return e.price.regularMarketDayHigh.raw}function getMarketDayLow(e){return e.price.regularMarketDayLow.raw}function get52WeekHigh(e){return e.summaryDetail.fiftyTwoWeekHigh.raw}function get52WeekLow(e){return e.summaryDetail.fiftyTwoWeekLow.raw}function getMarketVolume(e){return e.price.regularMarketVolume.raw}function getAverageVolume10days(e){return e.summaryDetail.averageVolume10days.raw}function getVolume24h(e){return e.price.volume24Hr.raw}function getMarketCap(e){return e.price.marketCap.raw}function getMarketChangePercent(e){return e.price.regularMarketChangePercent.raw}function deleteAllTriggers(){ScriptApp.getProjectTriggers().forEach(e=>{ScriptApp.deleteTrigger(e)})}function createAllTriggers(){deleteAllTriggers(),createShowWelcome()}function createShowWelcome(){const e=SpreadsheetApp.getActive();ScriptApp.newTrigger("showWelcome").forSpreadsheet(e).onOpen().create()}!function(e){"use strict";var t,r=20,n=1,o=1e6,i=-7,s=21,c="[big.js] ",u=c+"Invalid ",a=u+"decimal places",f=u+"rounding mode",l={},h=void 0,g=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i;function p(e,t,r,n){var o=e.c,i=e.e+t+1;if(i<o.length){if(1===r)n=o[i]>=5;else if(2===r)n=o[i]>5||5==o[i]&&(n||i<0||o[i+1]!==h||1&o[i-1]);else if(3===r)n=n||!!o[0];else if(n=!1,0!==r)throw Error(f);if(i<1)o.length=1,n?(e.e=-t,o[0]=1):o[0]=e.e=0;else{if(o.length=i--,n)for(;++o[i]>9;)o[i]=0,i--||(++e.e,o.unshift(1));for(i=o.length;!o[--i];)o.pop()}}else if(r<0||r>3||r!==~~r)throw Error(f);return e}function m(e,t,r,n){var i,s,c=e.constructor,f=!e.c[0];if(r!==h){if(r!==~~r||r<(3==t)||r>o)throw Error(3==t?u+"precision":a);for(r=n-(e=new c(e)).e,e.c.length>++n&&p(e,r,c.RM),2==t&&(n=e.e+r+1);e.c.length<n;)e.c.push(0)}if(i=e.e,r=(s=e.c.join("")).length,2!=t&&(1==t||3==t&&n<=i||i<=c.NE||i>=c.PE))s=s.charAt(0)+(r>1?"."+s.slice(1):"")+(i<0?"e":"e+")+i;else if(i<0){for(;++i;)s="0"+s;s="0."+s}else if(i>0)if(++i>r)for(i-=r;i--;)s+="0";else i<r&&(s=s.slice(0,i)+"."+s.slice(i));else r>1&&(s=s.charAt(0)+"."+s.slice(1));return e.s<0&&(!f||4==t)?"-"+s:s}l.abs=function(){var e=new this.constructor(this);return e.s=1,e},l.cmp=function(e){var t,r=this,n=r.c,o=(e=new r.constructor(e)).c,i=r.s,s=e.s,c=r.e,u=e.e;if(!n[0]||!o[0])return n[0]?i:o[0]?-s:0;if(i!=s)return i;if(t=i<0,c!=u)return c>u^t?1:-1;for(s=(c=n.length)<(u=o.length)?c:u,i=-1;++i<s;)if(n[i]!=o[i])return n[i]>o[i]^t?1:-1;return c==u?0:c>u^t?1:-1},l.div=function(e){var t=this,r=t.constructor,n=t.c,i=(e=new r(e)).c,s=t.s==e.s?1:-1,c=r.DP;if(c!==~~c||c<0||c>o)throw Error(a);if(!i[0])throw Error("[big.js] Division by zero");if(!n[0])return new r(0*s);var u,f,l,g,m,d=i.slice(),w=u=i.length,v=n.length,y=n.slice(0,u),A=y.length,S=e,R=S.c=[],M=0,E=c+(S.e=t.e-e.e)+1;for(S.s=s,s=E<0?0:E,d.unshift(0);A++<u;)y.push(0);do{for(l=0;l<10;l++){if(u!=(A=y.length))g=u>A?1:-1;else for(m=-1,g=0;++m<u;)if(i[m]!=y[m]){g=i[m]>y[m]?1:-1;break}if(!(g<0))break;for(f=A==u?i:d;A;){if(y[--A]<f[A]){for(m=A;m&&!y[--m];)y[m]=9;--y[m],y[A]+=10}y[A]-=f[A]}for(;!y[0];)y.shift()}R[M++]=g?l:++l,y[0]&&g?y[A]=n[w]||0:y=[n[w]]}while((w++<v||y[0]!==h)&&s--);return R[0]||1==M||(R.shift(),S.e--),M>E&&p(S,c,r.RM,y[0]!==h),S},l.eq=function(e){return!this.cmp(e)},l.gt=function(e){return this.cmp(e)>0},l.gte=function(e){return this.cmp(e)>-1},l.lt=function(e){return this.cmp(e)<0},l.lte=function(e){return this.cmp(e)<1},l.minus=l.sub=function(e){var t,r,n,o,i=this,s=i.constructor,c=i.s,u=(e=new s(e)).s;if(c!=u)return e.s=-u,i.plus(e);var a=i.c.slice(),f=i.e,l=e.c,h=e.e;if(!a[0]||!l[0])return l[0]?(e.s=-u,e):new s(a[0]?i:0);if(c=f-h){for((o=c<0)?(c=-c,n=a):(h=f,n=l),n.reverse(),u=c;u--;)n.push(0);n.reverse()}else for(r=((o=a.length<l.length)?a:l).length,c=u=0;u<r;u++)if(a[u]!=l[u]){o=a[u]<l[u];break}if(o&&(n=a,a=l,l=n,e.s=-e.s),(u=(r=l.length)-(t=a.length))>0)for(;u--;)a[t++]=0;for(u=t;r>c;){if(a[--r]<l[r]){for(t=r;t&&!a[--t];)a[t]=9;--a[t],a[r]+=10}a[r]-=l[r]}for(;0===a[--u];)a.pop();for(;0===a[0];)a.shift(),--h;return a[0]||(e.s=1,a=[h=0]),e.c=a,e.e=h,e},l.mod=function(e){var t,r=this,n=r.constructor,o=r.s,i=(e=new n(e)).s;if(!e.c[0])throw Error("[big.js] Division by zero");return r.s=e.s=1,t=1==e.cmp(r),r.s=o,e.s=i,t?new n(r):(o=n.DP,i=n.RM,n.DP=n.RM=0,r=r.div(e),n.DP=o,n.RM=i,this.minus(r.times(e)))},l.plus=l.add=function(e){var t,r=this,n=r.constructor,o=r.s,i=(e=new n(e)).s;if(o!=i)return e.s=-i,r.minus(e);var s=r.e,c=r.c,u=e.e,a=e.c;if(!c[0]||!a[0])return a[0]?e:new n(c[0]?r:0*o);if(c=c.slice(),o=s-u){for(o>0?(u=s,t=a):(o=-o,t=c),t.reverse();o--;)t.push(0);t.reverse()}for(c.length-a.length<0&&(t=a,a=c,c=t),o=a.length,i=0;o;c[o]%=10)i=(c[--o]=c[o]+a[o]+i)/10|0;for(i&&(c.unshift(i),++u),o=c.length;0===c[--o];)c.pop();return e.c=c,e.e=u,e},l.pow=function(e){var t=this,r=new t.constructor(1),n=r,o=e<0;if(e!==~~e||e<-1e6||e>1e6)throw Error(u+"exponent");for(o&&(e=-e);1&e&&(n=n.times(t)),e>>=1;)t=t.times(t);return o?r.div(n):n},l.round=function(e,t){var r=this.constructor;if(e===h)e=0;else if(e!==~~e||e<-o||e>o)throw Error(a);return p(new r(this),e,t===h?r.RM:t)},l.sqrt=function(){var e,t,r,n=this,o=n.constructor,i=n.s,s=n.e,u=new o(.5);if(!n.c[0])return new o(n);if(i<0)throw Error(c+"No square root");0===(i=Math.sqrt(n+""))||i===1/0?((t=n.c.join("")).length+s&1||(t+="0"),i=Math.sqrt(t),s=((s+1)/2|0)-(s<0||1&s),e=new o((i==1/0?"1e":(i=i.toExponential()).slice(0,i.indexOf("e")+1))+s)):e=new o(i),s=e.e+(o.DP+=4);do{r=e,e=u.times(r.plus(n.div(r)))}while(r.c.slice(0,s).join("")!==e.c.slice(0,s).join(""));return p(e,o.DP-=4,o.RM)},l.times=l.mul=function(e){var t,r=this,n=r.constructor,o=r.c,i=(e=new n(e)).c,s=o.length,c=i.length,u=r.e,a=e.e;if(e.s=r.s==e.s?1:-1,!o[0]||!i[0])return new n(0*e.s);for(e.e=u+a,s<c&&(t=o,o=i,i=t,a=s,s=c,c=a),t=new Array(a=s+c);a--;)t[a]=0;for(u=c;u--;){for(c=0,a=s+u;a>u;)c=t[a]+i[u]*o[a-u-1]+c,t[a--]=c%10,c=c/10|0;t[a]=c}for(c?++e.e:t.shift(),u=t.length;!t[--u];)t.pop();return e.c=t,e},l.toExponential=function(e){return m(this,1,e,e)},l.toFixed=function(e){return m(this,2,e,this.e+e)},l.toPrecision=function(e){return m(this,3,e,e-1)},l.toString=function(){return m(this)},l.valueOf=l.toJSON=function(){return m(this,4)},(t=function e(){function t(r){var n=this;if(!(n instanceof t))return r===h?e():new t(r);r instanceof t?(n.s=r.s,n.e=r.e,n.c=r.c.slice()):function(e,t){var r,n,o;if(0===t&&1/t<0)t="-0";else if(!g.test(t+=""))throw Error(u+"number");for(e.s="-"==t.charAt(0)?(t=t.slice(1),-1):1,(r=t.indexOf("."))>-1&&(t=t.replace(".","")),(n=t.search(/e/i))>0?(r<0&&(r=n),r+=+t.slice(n+1),t=t.substring(0,n)):r<0&&(r=t.length),o=t.length,n=0;n<o&&"0"==t.charAt(n);)++n;if(n==o)e.c=[e.e=0];else{for(;o>0&&"0"==t.charAt(--o););for(e.e=r-n-1,e.c=[],r=0;n<=o;)e.c[r++]=+t.charAt(n++)}}(n,r),n.constructor=t}return t.prototype=l,t.DP=r,t.RM=n,t.NE=i,t.PE=s,t.version="5.2.2",t}()).default=t.Big=t,"function"==typeof define&&define.amd?define(function(){return t}):"undefined"!=typeof module&&module.exports?module.exports=t:e.Big=t}(this);